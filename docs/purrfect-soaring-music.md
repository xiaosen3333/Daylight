# ç¡çœ æ—¶é—´çª—å£æ—¥æœŸé”™ä¹±é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## ä¸€ã€é—®é¢˜æ¦‚è¿°

### 1.1 æ ¸å¿ƒ Bug

`DateHelper.swift` ä¸­çš„ `localDayString()` å‡½æ•°åªæ£€æŸ¥ `endMinutes`ï¼Œæ²¡æœ‰åŒºåˆ†**åŒæ—¥çª—å£**å’Œ**è·¨æ—¥çª—å£**ï¼Œå¯¼è‡´åˆ‡æ—¥é€»è¾‘é”™è¯¯ã€‚

```
é”™è¯¯ä»£ç é€»è¾‘ï¼š
if minutesIntoDay <= endMinutes {
    å›é€€åˆ°æ˜¨å¤©  // âŒ ä¸åŒºåˆ†çª—å£ç±»å‹
}
```

### 1.2 é—®é¢˜åœºæ™¯ç¤ºä¾‹

| çª—å£ç±»å‹ | è®¾ç½® | å½“å‰æ—¶é—´ | å½“å‰è¡Œä¸º | æ­£ç¡®è¡Œä¸º |
|---------|------|---------|---------|---------|
| åŒæ—¥çª—å£ | 21:30-23:59 | 10:00 | è¿”å›æ˜¨å¤© âŒ | è¿”å›ä»Šå¤© |
| åŒæ—¥çª—å£ | 21:30-23:59 | 22:00 | è¿”å›æ˜¨å¤© âŒ | è¿”å›ä»Šå¤© |
| è·¨æ—¥çª—å£ | 22:30-01:30 | 00:30 | è¿”å›æ˜¨å¤© âœ“ | è¿”å›æ˜¨å¤© |
| è·¨æ—¥çª—å£ | 22:30-01:30 | 02:00 | è¿”å›æ˜¨å¤© âŒ | è¿”å›ä»Šå¤© |

---

## äºŒã€åˆ‡æ—¥è§„åˆ™å®šä¹‰

### 2.1 æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŒæ—¥çª—å£ (start <= end)ï¼Œå¦‚ 21:30-23:59                                 â”‚
â”‚                                                                          â”‚
â”‚  æ—¶é—´çº¿: 0:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 21:30 â•â•â•â•â•â•â•â• 23:59 â”€â”€ 24:00        â”‚
â”‚                    ä»Šå¤©              â”‚   å¤œé—´çª—å£   â”‚  ä»Šå¤©              â”‚
â”‚                                                                          â”‚
â”‚  åˆ‡æ—¥ç‚¹ = 00:00ï¼ˆåˆå¤œï¼‰                                                   â”‚
â”‚  è§„åˆ™ï¼šæ‰€æœ‰æ—¶é—´éƒ½ç”¨è‡ªç„¶æ—¥å†æ—¥æœŸï¼Œæ— éœ€å›é€€                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·¨æ—¥çª—å£ (start > end)ï¼Œå¦‚ 22:30-01:30                                  â”‚
â”‚                                                                          â”‚
â”‚  æ—¶é—´çº¿: 0:00 â•â• 1:30 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 22:30 â•â•â•â• 24:00      â”‚
â”‚            â”‚æ˜¨å¤©â”‚              ä»Šå¤©               â”‚   ä»Šå¤©çª—å£  â”‚         â”‚
â”‚          (çª—å£)                                                          â”‚
â”‚                                                                          â”‚
â”‚  åˆ‡æ—¥ç‚¹ = 01:31ï¼ˆend + 1 åˆ†é’Ÿï¼‰                                           â”‚
â”‚  è§„åˆ™ï¼š00:00 ~ endMinutes å±äºæ˜¨å¤©ï¼Œå…¶ä½™å±äºä»Šå¤©                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 åˆ¤æ–­æµç¨‹å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  localDayString(date, window)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ startMinutes = parse(start) â”‚
                    â”‚ endMinutes = parse(end)     â”‚
                    â”‚ nowMinutes = hour*60+minute â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    start > end ?            â”‚
                    â”‚   (æ˜¯å¦è·¨æ—¥çª—å£)             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ NO (åŒæ—¥çª—å£)                            â”‚ YES (è·¨æ—¥çª—å£)
              â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›å½“å¤©æ—¥æœŸ             â”‚              â”‚ nowMinutes <= endMinutes ?  â”‚
â”‚ åˆ‡æ—¥ç‚¹ = 00:00          â”‚              â”‚ (åœ¨å‡Œæ™¨çš„çª—å£éƒ¨åˆ†å—ï¼Ÿ)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ YES                        â”‚ NO
                                          â–¼                            â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ è¿”å›æ˜¨å¤©æ—¥æœŸ             â”‚  â”‚ è¿”å›å½“å¤©æ—¥æœŸ             â”‚
                            â”‚ (åœ¨è·¨æ—¥çª—å£çš„å‡Œæ™¨éƒ¨åˆ†)   â”‚  â”‚ (çª—å£å¤–æˆ–æ™šé—´éƒ¨åˆ†)        â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€å½±å“èŒƒå›´

### 3.1 è°ƒç”¨é“¾è·¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DateHelper.swift (æ ¸å¿ƒä¿®æ”¹ç‚¹)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  localDayString() â—„â”€â”€ éœ€è¦ä¿®å¤         nextLocalDayBoundary() â—„â”€â”€ éœ€è¦ä¿®å¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                     â”‚
            â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TodayViewModel.swift (è‡ªåŠ¨å—ç›Š)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  todayKey() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ è°ƒç”¨ localDayString()                     â”‚
â”‚  todayDate() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ è°ƒç”¨ todayKey()                           â”‚
â”‚  refreshIfNeeded() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ è°ƒç”¨ localDayString()                     â”‚
â”‚  scheduleDayChangeCheck() â”€â”€â”€â”€â”€â”€â”€â”€â–¶ è°ƒç”¨ nextLocalDayBoundary()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â–¼               â–¼                    â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UseCases   â”‚ â”‚ TodayView      â”‚ â”‚ LightChainPage â”‚ â”‚ Notifications    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7å¤„è°ƒç”¨    â”‚ â”‚ ä¸»é¡µæ ‡é¢˜       â”‚ â”‚ æ—¥å†é«˜äº®       â”‚ â”‚ dayKey å‚æ•°      â”‚
â”‚            â”‚ â”‚ CTA çŠ¶æ€       â”‚ â”‚ è¯¦æƒ…å¡æ—¥æœŸ     â”‚ â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 UI ç»„ä»¶å—å½±å“æ¸…å•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              TodayView (ä¸»é¡µ)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚     â˜€ï¸ [å‘å…‰å¤ªé˜³]        â”‚                                                â”‚
â”‚  â”‚                         â”‚                                                â”‚
â”‚  â”‚   "ç‚¹äº®ä»Šå¤©çš„ç¯"  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ homeTitle (ä¾èµ– state.record)              â”‚
â”‚  â”‚   "å¼€å§‹æ–°çš„ä¸€å¤©"  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ homeSubtitle                               â”‚
â”‚  â”‚                         â”‚                                                â”‚
â”‚  â”‚  [å¼€å§‹ä»Šæ—¥æ‰¿è¯º] â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ getStartedButton (ä¾èµ– homeStatus)         â”‚
â”‚  â”‚  [ç°åœ¨ç¡è§‰]     â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ sleepCTAButton (ä¾èµ– shouldShowNightCTA)   â”‚
â”‚  â”‚                         â”‚                                                â”‚
â”‚  â”‚  â—‹ â—‹ â— â— â— â—‹ â—‹  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ lightChainBar (ä¾èµ– lightChain è®°å½•)        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LightChainPage / ç»Ÿè®¡é¡µ (æ—¥å†è§†å›¾)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  â—„  November 2024  â–º                                             â”‚       â”‚
â”‚  â”‚  Su  Mo  Tu  We  Th  Fr  Sa                                      â”‚       â”‚
â”‚  â”‚                          1   2                                   â”‚       â”‚
â”‚  â”‚   3   4   5   6   7   8   9                                      â”‚       â”‚
â”‚  â”‚  10  11  12  13  14  15  16                                      â”‚       â”‚
â”‚  â”‚  17  18  19  20  21  22  23                                      â”‚       â”‚
â”‚  â”‚  24  25 [26] 27  28  29  30  â—„â”€â”€â”€ ä»Šæ—¥é«˜äº® (ä¾èµ– todayKey)        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  ğŸ“… 2024å¹´11æœˆ26æ—¥  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¯¦æƒ…å¡æ—¥æœŸ                  â”‚       â”‚
â”‚  â”‚  æ‰¿è¯º: "ä»Šå¤©æ—©ç‚¹ç¡è§‰"                                             â”‚       â”‚
â”‚  â”‚  å…¥ç¡æ—¶é—´: 23:30                                                  â”‚       â”‚
â”‚  â”‚  æ‹’ç»æ¬¡æ•°: 2                                                      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€ä¿®å¤æ–¹æ¡ˆ

### 4.1 æ–‡ä»¶ 1ï¼šDateHelper.swift

**è·¯å¾„**: `Daylight/Core/Utils/DateHelper.swift`

#### ä¿®æ”¹ 1ï¼š`localDayString()` å‡½æ•°ï¼ˆç¬¬ 30-51 è¡Œï¼‰

```swift
// ä¿®æ”¹å‰ï¼ˆæœ‰ Bugï¼‰
func localDayString(for date: Date = Date(), nightWindow: NightWindow) -> String {
    // ...
    let endMinutes = minutes(for: nightWindow.end)
    if minutesIntoDay <= endMinutes {
        baseDate = calendar.date(byAdding: .day, value: -1, to: ...) // âŒ æ€»æ˜¯å›é€€
    }
}

// ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
func localDayString(for date: Date = Date(), nightWindow: NightWindow) -> String {
    var calendar = calendar
    calendar.timeZone = timeZone

    let components = calendar.dateComponents(in: timeZone, from: date)
    guard let hour = components.hour, let minute = components.minute else {
        return dayFormatter.string(from: date)
    }

    let minutesIntoDay = hour * 60 + minute
    let startMinutes = minutes(for: nightWindow.start)
    let endMinutes = minutes(for: nightWindow.end)

    // å…³é”®ä¿®å¤ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºè·¨æ—¥çª—å£
    let isCrossMidnight = startMinutes > endMinutes

    let baseDate: Date
    if isCrossMidnight && minutesIntoDay <= endMinutes {
        // åªæœ‰è·¨æ—¥çª—å£ä¸”åœ¨å‡Œæ™¨çš„ 0:00 ~ endMinutes èŒƒå›´å†…ï¼Œæ‰å±äº"æ˜¨å¤©"
        baseDate = calendar.date(byAdding: .day, value: -1, to: calendar.startOfDay(for: date))
            ?? calendar.startOfDay(for: date)
    } else {
        // åŒæ—¥çª—å£ æˆ– è·¨æ—¥çª—å£çš„ç™½å¤©/æ™šé—´éƒ¨åˆ†ï¼šè¿”å›å½“å¤©
        baseDate = calendar.startOfDay(for: date)
    }

    return dayFormatter.string(from: baseDate)
}
```

#### ä¿®æ”¹ 2ï¼š`nextLocalDayBoundary()` å‡½æ•°ï¼ˆç¬¬ 53-70 è¡Œï¼‰

```swift
// ä¿®æ”¹å‰ï¼ˆæœ‰ Bugï¼‰
func nextLocalDayBoundary(after date: Date = Date(), nightWindow: NightWindow) -> Date {
    let endMinutes = minutes(for: nightWindow.end) + 1  // âŒ ä¸åŒºåˆ†çª—å£ç±»å‹
    // ...
}

// ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
func nextLocalDayBoundary(after date: Date = Date(), nightWindow: NightWindow) -> Date {
    var calendar = calendar
    calendar.timeZone = timeZone

    let startMinutes = minutes(for: nightWindow.start)
    let endMinutes = minutes(for: nightWindow.end)
    let isCrossMidnight = startMinutes > endMinutes

    let startOfDay = calendar.startOfDay(for: date)

    if isCrossMidnight {
        // è·¨æ—¥çª—å£ï¼šåˆ‡æ—¥ç‚¹åœ¨ endMinutes + 1
        let boundaryMinutes = endMinutes + 1
        guard let candidate = calendar.date(byAdding: .minute, value: boundaryMinutes, to: startOfDay) else {
            return date
        }
        if date < candidate {
            return candidate
        }
        guard let tomorrow = calendar.date(byAdding: .day, value: 1, to: startOfDay),
              let next = calendar.date(byAdding: .minute, value: boundaryMinutes, to: tomorrow) else {
            return candidate
        }
        return next
    } else {
        // åŒæ—¥çª—å£ï¼šåˆ‡æ—¥ç‚¹å°±æ˜¯åˆå¤œ 00:00
        guard let tomorrow = calendar.date(byAdding: .day, value: 1, to: startOfDay) else {
            return date
        }
        if date < tomorrow {
            return tomorrow
        }
        guard let dayAfter = calendar.date(byAdding: .day, value: 2, to: startOfDay) else {
            return tomorrow
        }
        return dayAfter
    }
}
```

### 4.2 æ— éœ€ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆè‡ªåŠ¨å—ç›Šï¼‰

ä»¥ä¸‹æ–‡ä»¶è°ƒç”¨äº† `localDayString()`ï¼Œä¿®å¤æ ¸å¿ƒå‡½æ•°åè‡ªåŠ¨è·å¾—æ­£ç¡®è¡Œä¸ºï¼š

| æ–‡ä»¶ | è°ƒç”¨ç‚¹ | è¯´æ˜ |
|-----|-------|------|
| TodayViewModel.swift | `todayKey()`, `refreshIfNeeded()` | è‡ªåŠ¨ä¿®å¤ |
| DaylightUseCases.swift | 7 å¤„ UseCase | è‡ªåŠ¨ä¿®å¤ |
| TodayView.swift | é€šè¿‡ ViewModel | è‡ªåŠ¨ä¿®å¤ |
| LightChainPage.swift | é€šè¿‡ ViewModel | è‡ªåŠ¨ä¿®å¤ |
| NotificationScheduler.swift | æ¥æ”¶ dayKey å‚æ•° | è‡ªåŠ¨ä¿®å¤ |

### 4.3 isInNightWindow() å‡½æ•°

è¯¥å‡½æ•°ï¼ˆç¬¬ 88-104 è¡Œï¼‰é€»è¾‘**å·²ç»æ­£ç¡®**ï¼Œæ— éœ€ä¿®æ”¹ï¼š

```swift
func isInNightWindow(_ date: Date = Date(), window: NightWindow) -> Bool {
    // ...
    if startMinutes <= endMinutes {
        return minutesIntoDay >= startMinutes && minutesIntoDay <= endMinutes
    }
    // window è·¨æ—¥
    return minutesIntoDay >= startMinutes || minutesIntoDay <= endMinutes
}
```

---

## äº”ã€æµ‹è¯•éªŒè¯

### 5.1 åŒæ—¥çª—å£æµ‹è¯•ï¼ˆ21:30-23:59ï¼‰

| å½“å‰æ—¶é—´ | æœŸæœ› dayKey | ä¿®å¤å |
|---------|------------|--------|
| 10:00   | ä»Šå¤©       | âœ… ä»Šå¤© |
| 21:00   | ä»Šå¤©       | âœ… ä»Šå¤© |
| 22:00   | ä»Šå¤©       | âœ… ä»Šå¤© |
| 23:30   | ä»Šå¤©       | âœ… ä»Šå¤© |
| 00:30 æ¬¡æ—¥ | æ¬¡æ—¥   | âœ… æ¬¡æ—¥ |

### 5.2 è·¨æ—¥çª—å£æµ‹è¯•ï¼ˆ22:30-01:30ï¼‰

| å½“å‰æ—¶é—´ | æœŸæœ› dayKey | ä¿®å¤å |
|---------|------------|--------|
| 10:00   | ä»Šå¤©       | âœ… ä»Šå¤© |
| 00:30   | æ˜¨å¤©       | âœ… æ˜¨å¤© |
| 01:00   | æ˜¨å¤©       | âœ… æ˜¨å¤© |
| 01:30   | æ˜¨å¤©       | âœ… æ˜¨å¤© |
| 01:31   | ä»Šå¤©       | âœ… ä»Šå¤© |
| 22:00   | ä»Šå¤©       | âœ… ä»Šå¤© |
| 23:00   | ä»Šå¤©       | âœ… ä»Šå¤© |

### 5.3 è¾¹ç•Œæƒ…å†µæµ‹è¯•

| åœºæ™¯ | è®¾ç½® | æœŸæœ›è¡Œä¸º |
|-----|------|---------|
| start == end | 22:00-22:00 | è§†ä¸ºåŒæ—¥çª—å£ï¼Œåˆ‡æ—¥ç‚¹ 00:00 |
| end = 00:00 | 22:00-00:00 | è·¨æ—¥çª—å£ï¼Œ00:00 å±äºæ˜¨å¤©ï¼Œ00:01 å±äºä»Šå¤© |

---

## å…­ã€å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šä¿®æ”¹ DateHelper.swift
- ä¿®å¤ `localDayString()` å‡½æ•°
- ä¿®å¤ `nextLocalDayBoundary()` å‡½æ•°

### æ­¥éª¤ 2ï¼šæ‰‹åŠ¨æµ‹è¯•éªŒè¯
- è®¾ç½®åŒæ—¥çª—å£ï¼ˆ21:30-23:59ï¼‰ï¼ŒéªŒè¯å„æ—¶é—´ç‚¹çš„æ—¥æœŸæ˜¾ç¤º
- è®¾ç½®è·¨æ—¥çª—å£ï¼ˆ22:30-01:30ï¼‰ï¼ŒéªŒè¯å„æ—¶é—´ç‚¹çš„æ—¥æœŸæ˜¾ç¤º
- æ£€æŸ¥ä¸»é¡µæ ‡é¢˜ã€CTA çŠ¶æ€ã€æ—¥å†é«˜äº®ã€è¯¦æƒ…å¡æ—¥æœŸ

### æ­¥éª¤ 3ï¼šå›å½’æµ‹è¯•
- ç¡®ä¿ç°æœ‰çš„è·¨æ—¥çª—å£åœºæ™¯ä»ç„¶æ­£å¸¸
- ç¡®ä¿é€šçŸ¥æ’ç¨‹ä¸æ–°åˆ‡æ—¥é€»è¾‘ä¸€è‡´

---

## ä¸ƒã€å…³é”®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | ä¼˜å…ˆçº§ |
|-----|---------|--------|
| `Core/Utils/DateHelper.swift` | **å¿…é¡»ä¿®æ”¹** | P0 |
| `Presentation/Today/TodayViewModel.swift` | æ— éœ€ä¿®æ”¹ï¼ˆéªŒè¯ï¼‰ | - |
| `Domain/UseCases/DaylightUseCases.swift` | æ— éœ€ä¿®æ”¹ï¼ˆéªŒè¯ï¼‰ | - |
| `Presentation/Today/TodayView.swift` | æ— éœ€ä¿®æ”¹ï¼ˆéªŒè¯ï¼‰ | - |
| `Presentation/LightChain/LightChainPage.swift` | æ— éœ€ä¿®æ”¹ï¼ˆéªŒè¯ï¼‰ | - |
| `Core/Utils/NotificationScheduler.swift` | æ— éœ€ä¿®æ”¹ï¼ˆéªŒè¯ï¼‰ | - |
